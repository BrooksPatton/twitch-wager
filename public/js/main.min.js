var a=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/user",createStream:function(){this.set("stream",new b({username:this.get("name")})),this.get("stream").save(),this.set("streaming",!0)},startRound:function(a){this.get("stream").set("playing",!0).set("betting",!0).set("gameId",this.get("stream").get("gameId")+1).save(),this.startBetTimer(),a.render()},lockBetting:function(){this.get("stream").fetch({success:function(a){a.set("betting",!1).save()}})},endStream:function(a){this.get("stream").destroy(),this.unset("stream"),this.set("streaming",!1),a.render()},startBetTimer:function(){var a=this;setTimeout(function(){a.lockBetting()},6e4)},gameWon:function(a){this.get("stream").set("previousResult","success").set("playing",!1).save(),a.render(),$.post("/game-won",{gameId:this.get("stream").id})},gameLost:function(a){this.get("stream").set("previousResult","fail").set("playing",!1).save(),a.render(),$.post("/game-lost",{gameId:this.get("stream").id})},removeFim:function(a){this.set("fim",this.get("fim")-a).save()}}),b=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/stream",betWin:function(a,b){var c=this.get("wagers"),d=_.findWhere(c,{userId:a.id});if(d){var e=_.indexOf(c,d);"success"===d.wager?c[e].amount=d.amount+10:(c[e].wager="success",c[e].amount=10)}else c.unshift({user:a.get("name"),wager:"success",amount:10,userId:a.id});this.set("wagers",c),this.save(),a.removeFim(10),b.updateFimView()},betLose:function(a,b){var c=this.get("wagers"),d=_.findWhere(c,{userId:a.id});if(d){var e=_.indexOf(c,d);"fail"===d.wager?c[e].amount=d.amount+10:(c[e].wager="fail",c[e].amount=10)}else c.unshift({user:a.get("name"),wager:"fail",amount:10,userId:a.id});this.set("wagers",c),this.save(),a.removeFim(10),b.updateFimView()}}),c=Backbone.Collection.extend({model:b,url:"/stream",start:function(){var a=this;setInterval(function(){a.fetch()},1e3)}}),d=Backbone.View.extend({tagName:"p",className:"navbar-text",initialize:function(){var a=this;setInterval(function(){a.model.fetch({success:function(){a.render()}})},1e3)},render:function(){this.$el.html("FIM: "+this.model.get("fim"))}}),e=Backbone.View.extend({className:"col-xs-8",render:function(){var a=Handlebars.compile($("#streamer-console-template").html());this.$el.html(a(this.model.toJSON()))},events:{"click #start-stream":"registerStream","click #start-round":"startRound","click #end-stream":"endStream","click #game-success":"gameWon","click #game-fail":"gameLost"},registerStream:function(){this.model.createStream(),this.render(),this.renderWagers(this.model.get("stream"))},startRound:function(){this.model.startRound(this)},endStream:function(){this.model.endStream(this)},gameWon:function(){this.model.gameWon(this)},gameLost:function(){this.model.gameLost(this)},renderWagers:function(a){var b=new h({model:a});b.render(),$("#wagers").html(b.el)}}),f=Backbone.View.extend({className:"container",initialize:function(){this.collection.on("add",this.render,this),this.collection.on("remove",this.render,this),this.template=Handlebars.compile($("#select-stream-template").html())},events:{"click .stream":"selectedStream"},render:function(){return this.$el.html(this.template({streams:this.collection.toJSON()})),this.el},selectedStream:function(a){i.navigate("view-stream/"+$(a.currentTarget).data("name"),{trigger:!0})}}),g=Backbone.View.extend({className:"container-fluid",initialize:function(){this.template=Handlebars.compile($("#view-stream-template").html()),this.user=new a({_id:userId}),this.user.fetch();var b=this;setInterval(function(){b.model.fetch()},2e3),this.model.on("change",this.setBets,this)},events:{"click #bet-win":"betWin","click #bet-lose":"betLose"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.el},betWin:function(){this.model.betWin(this.user,this)},betLose:function(){this.model.betLose(this.user,this)},updateFimView:function(){this.user.fetch({success:function(a){var b=new d({model:a});b.render(),$("#user-fim-count").html(b.el)}})},setBets:function(){this.model.get("betting")?$("#betting-on").removeClass("hidden"):$("#betting-on").addClass("hidden")}}),h=Backbone.View.extend({className:"col-xs-4",initialize:function(){this.template=Handlebars.compile($("#wagers-template").html()),this.model.on("all",this.render,this);var a=this;setInterval(function(){a.model.fetch()},1e3)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.el}}),i=new(Backbone.Router.extend({routes:{"twitch-wager":"index",streamer:"streamer","view-stream/:streamer":"viewStream"},start:function(){Backbone.history.start({pushState:!0})},initialize:function(){this.user=new a({_id:userId}),this.fimView=new d({model:this.user}),$("#user-fim-count").html(this.fimView.el),this.streams=new c,this.user.fetch(),$("#register-stream").on("click",function(){i.navigate("streamer",{trigger:!0})})},index:function(){$("#wager").html("");var a=new f({collection:this.streams});a.render(),$("#main").html(a.el),this.streams.start()},streamer:function(){$("#wager").html(""),this.streams.fetch();var a=new e({model:this.user}),b=this.streams.findWhere({username:this.user.get("name")});b?(this.user.set("streaming",!0),this.user.set("stream",b),a.render(),$("#main").html(a.el),a.renderWagers(b)):(this.user.set("streaming",!1),a.render(),$("#main").html(a.el))},viewStream:function(a){var b=this.streams.findWhere({username:a}),c=new g({model:b}),d=new h({model:b});d.render(),c.render(),$("#wagers").html(d.el),$("#main").html(c.el)}}));$(function(){i.start()});